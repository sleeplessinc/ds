#!/usr/bin/env node

var http	= require( 'http' );
var url		= require( 'url' );

var DS		= require( '../' ).DS;
var store	= new DS( './ds.json' );

http.ServerResponse.prototype.writeJSON = function( json ) {
	this.write( JSON.stringify( json ) );

	this.end();
}

http.ServerResponse.prototype.error	= function( err ) {
	this.writeJSON( { 'err' : err } );
}

http.ServerResponse.prototype.success	= function( msg ) {
	this.writeJSON( { 'ok' : msg } );
}

function listener( req, res ) {
	var query	= url.parse( req.url, true ).query;

	var act		= query.act;
	var key		= query.key;

	if( typeof store[ key ] === 'function' ) {
		// reserved keyword, handle this better

		res.error( 'Reserved keyword specified!' );

		return;
	}

	switch( act ) {
		case 'get':
			var val = store[ key ];

			if( val ) {
				res.success( val );
			} else {
				res.error( 'Invalid key!' );
			}
		break;

		case 'set':
			var val = query.val;

			if( ! val ) {
				res.error( 'No value specified!' );
			} else {
				try {
					var parsed = JSON.parse( val );

					store[ key ] = parsed;

					res.success( 'Write successful.' );
				} catch( e ) {
					res.error( 'Invalid JSON specified!' );
				}
			}
		break;

		case 'del':
			delete store[ key ];

			res.success( 'Delete successful.' );
		break;
	}

	console.log( store );
}

var server	= http.createServer( listener );

server.listen( 3000 );
